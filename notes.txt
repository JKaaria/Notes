Sub PerformSectorAnalysis()
    Dim wsAllOfferings As Worksheet
    Dim wsOverview As Worksheet
    Dim lastRow As Long
    Dim sectorColumn As Range
    Dim uniqueSectors As Collection
    Dim sector As Variant
    Dim rowNum As Long
    Dim summaryRow As Long

    ' Set references to sheets
    On Error Resume Next
    Set wsAllOfferings = ThisWorkbook.Sheets("All Offerings")
    On Error GoTo 0

    If wsAllOfferings Is Nothing Then
        MsgBox "Sheet 'All Offerings' not found!", vbExclamation
        Exit Sub
    End If

    ' Check if "Overview" sheet already exists, if yes, delete it
    On Error Resume Next
    Application.DisplayAlerts = False
    Set wsOverview = ThisWorkbook.Sheets("Overview")
    On Error GoTo 0
    Application.DisplayAlerts = True

    If Not wsOverview Is Nothing Then
        Application.DisplayAlerts = False
        wsOverview.Delete
        Application.DisplayAlerts = True
    End If

    ' Create a new sheet named "Overview"
    Set wsOverview = Sheets.Add(After:=Sheets(Sheets.Count))
    wsOverview.Name = "Overview"

    ' Find the last row in the "All Offerings" sheet
    lastRow = wsAllOfferings.Cells(wsAllOfferings.Rows.Count, "A").End(xlUp).Row

    ' Add headers for sector analysis
    wsOverview.Cells(1, 34).Value = "Sector Analysis"

    ' Set the sector column to column X
    Set sectorColumn = wsAllOfferings.Columns("X")

    If Not sectorColumn Is Nothing Then
        ' Extract unique sectors using a collection
        Set uniqueSectors = New Collection

        For rowNum = 2 To lastRow
            On Error Resume Next
            uniqueSectors.Add wsAllOfferings.Cells(rowNum, sectorColumn.Column).Value, CStr(wsAllOfferings.Cells(rowNum, sectorColumn.Column).Value)
            On Error GoTo 0
        Next rowNum

        ' Add headers for sector metrics
        wsOverview.Cells(2, 34).Value = "Sector"
        wsOverview.Cells(2, 35).Value = "Total Offerings"
        wsOverview.Cells(2, 36).Value = "Total Offer Amount (MM)"
        wsOverview.Cells(2, 37).Value = "Average Discount"
        wsOverview.Cells(2, 38).Value = "Total Maturity Value (MM)"
        wsOverview.Cells(2, 39).Value = "Average Days to Maturity (DTM)"
        wsOverview.Cells(2, 40).Value = "Total Net Upfront (MM)"

        ' Loop through unique sectors and calculate metrics
        summaryRow = 3
        For Each sector In uniqueSectors
            wsOverview.Cells(summaryRow, 34).Value = sector
            wsOverview.Cells(summaryRow, 35).Formula = "=COUNTIFS('All Offerings'!" & sectorColumn.Address & ",""" & sector & """)"
            wsOverview.Cells(summaryRow, 36).Formula = "=SUMIFS('All Offerings'!B:B,'All Offerings'!" & sectorColumn.Address & ",""" & sector & """)"
            wsOverview.Cells(summaryRow, 37).Formula = "=AVERAGEIFS('All Offerings'!C:C,'All Offerings'!" & sectorColumn.Address & ",""" & sector & """)"
            wsOverview.Cells(summaryRow, 38).Formula = "=SUMIFS('All Offerings'!B:B*(1+'All Offerings'!C:C/100),'All Offerings'!" & sectorColumn.Address & ",""" & sector & """)"
            wsOverview.Cells(summaryRow, 39).Formula = "=AVERAGEIFS('All Offerings'!D:D,'All Offerings'!" & sectorColumn.Address & ",""" & sector & """)"
            wsOverview.Cells(summaryRow, 40).Formula = "=SUMIFS('All Offerings'!V:V,'All Offerings'!" & sectorColumn.Address & ",""" & sector & """)"
            summaryRow = summaryRow + 1
        Next sector

        ' Format the "Overview" sheet
        wsOverview.Columns.AutoFit

        MsgBox "Sector Analysis completed successfully!", vbInformation
    Else
        MsgBox "Sector column not found in 'All Offerings' sheet!", vbExclamation
    End If
End Sub
