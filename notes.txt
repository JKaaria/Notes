Sub GenerateEmails()
    Dim ws As Worksheet
    Dim rngData As Range
    Dim filterCriteria As Variant
    Dim emailBody As String
    Dim outlookApp As Object
    Dim outlookMail As Object
    Dim i As Long
    Dim header As Variant
    Dim statusReasonCol As Long
    
    ' Set the active worksheet
    Set ws = ActiveSheet
    
    ' Set the data range (assuming headers are in row 1)
    Set rngData = ws.UsedRange
    
    ' Define the filter criteria
    filterCriteria = Array("DDAT", "DDEA", "DELN", "DQUA", "DSEC", "DTRD", "MINO", "MUNO")
    
    ' Find the column number for "STATUS_REASON"
    statusReasonCol = WorksheetFunction.Match(" STATUS_REASON", ws.Rows(1), 0)
    
    ' Loop through visible rows after filtering
    For i = 2 To rngData.Rows.Count
        ' Check if the row meets the filter criteria
        If IsError(Application.Match(ws.Cells(i, statusReasonCol).Value, filterCriteria, 0)) Then
            ' Initialize email body
            emailBody = "<html><body><p>Dear recipient,</p><p>Below are the details for the selected row:</p><table border='1' style='border-collapse: collapse;'>"
            
            ' Add headers to the email body
            emailBody = emailBody & "<tr>"
            For Each header In Array(" TRADE_DATE", " SETTLEMENT_DATE", " DIRECTION", " PRICE", " QUANTITY_OUT", " SETTLEMENT_CURRENCY", " ISIN", " STATUS_DESC", " NARRATIVE", " FO_Trade_ID", " Salesperson Name")
                emailBody = emailBody & "<th>" & header & "</th>"
            Next header
            emailBody = emailBody & "</tr>"
            
            ' Add row contents to the email body as an HTML table row
            emailBody = emailBody & "<tr>"
            For Each header In Array(" TRADE_DATE", " SETTLEMENT_DATE", " DIRECTION", " PRICE", " QUANTITY_OUT", " SETTLEMENT_CURRENCY", " ISIN", " STATUS_DESC", " NARRATIVE", " FO_Trade_ID", " Salesperson Name")
                emailBody = emailBody & "<td>" & ws.Cells(i, WorksheetFunction.Match(header, ws.Rows(1), 0)).Value & "</td>"
            Next header
            emailBody = emailBody & "</tr>"
            
            ' Close the HTML table and body tags
            emailBody = emailBody & "</table></body></html>"
            
            ' Create Outlook Application
            Set outlookApp = CreateObject("Outlook.Application")
            
            ' Create a new mail item
            Set outlookMail = outlookApp.CreateItem(0)
            
            ' Customize email properties
            With outlookMail
                .Subject = "Data Summary for Row: " & i
                .HTMLBody = emailBody
                .Display ' Change to .Send if you want to send the email automatically
            End With
            
            ' Release Outlook mail object
            Set outlookMail = Nothing
        End If
    Next i
End Sub

