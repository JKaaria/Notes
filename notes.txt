Sub VLOOKUPAndFilter()
    Dim wsTrade As Worksheet
    Dim wsLogicTable As Worksheet
    Dim lastRowTrade As Long
    Dim lastRowLogicTable As Long
    Dim counterpartyIDHeader As Range
    Dim rngCounterpartyID As Range
    Dim rngVLookupResults As Range
    Dim vlookupFormula As String

    ' Set worksheets
    Set wsTrade = ThisWorkbook.Sheets("TradeData") ' Replace "TradeData" with the actual name of your trade data sheet
    Set wsLogicTable = ThisWorkbook.Sheets("LogicTable") ' Replace "LogicTable" with the actual name of your logic table sheet

    ' Find "Counterparty ID" column header in "TradeData" sheet
    On Error Resume Next
    Set counterpartyIDHeader = wsTrade.Rows(1).Find("Counterparty ID", LookIn:=xlValues)
    On Error GoTo 0

    ' Check if header is found in "TradeData" sheet
    If Not counterpartyIDHeader Is Nothing Then
        ' Set range for "Counterparty ID" column in "TradeData" sheet
        Set rngCounterpartyID = wsTrade.Columns(counterpartyIDHeader.Column)

        ' Insert a column to the right of "Counterparty ID" in "TradeData" sheet
        rngCounterpartyID.Offset(, 1).EntireColumn.Insert

        ' Find the last row in "TradeData" sheet
        lastRowTrade = wsTrade.Cells(wsTrade.Rows.Count, rngCounterpartyID.Column).End(xlUp).Row

        ' Find the last row in "LogicTable" sheet
        lastRowLogicTable = wsLogicTable.Cells(wsLogicTable.Rows.Count, 1).End(xlUp).Row

        ' Create VLOOKUP formula
        vlookupFormula = "=VLOOKUP(" & rngCounterpartyID.Cells(2, 1).Address & "," & _
                         wsLogicTable.Range("A:D").Address & ",4,FALSE)"

        ' Apply VLOOKUP formula to the newly inserted column in "TradeData" sheet
        rngCounterpartyID.Offset(, 1).Resize(lastRowTrade, 1).Formula = vlookupFormula

        ' Convert formulas to values
        rngCounterpartyID.Offset(, 1).Resize(lastRowTrade, 1).Value = _
            rngCounterpartyID.Offset(, 1).Resize(lastRowTrade, 1).Value

        ' Set range for VLOOKUP results
        Set rngVLookupResults = rngCounterpartyID.Offset(, 1).Resize(lastRowTrade, 1)

        ' Apply AutoFilter to "VLOOKUP Results" column
        rngVLookupResults.AutoFilter Field:=1, Criteria1:="<>" & vbNullString

        ' Display a message (you can modify this part as needed)
        MsgBox "VLOOKUP results filtered in 'TradeData' sheet.", vbInformation
    Else
        MsgBox "Column header 'Counterparty ID' not found in 'TradeData' sheet!", vbExclamation
    End If
End Sub
