Sub CompareAndCopyToRecBreaks()

    ' Define variables
    Dim wsTrade As Worksheet
    Dim wsLogic As Worksheet
    Dim wsRecBreaks As Worksheet
    Dim lastRowTrade As Long
    Dim lastRowLogic As Long
    Dim tradeCounterpartyIDCol As Integer
    Dim logicSDSCol As Integer
    Dim tradeSettleLegalEntityCol As Integer
    Dim logicEntityCol As Integer
    Dim i As Long, j As Long
    Dim recBreaksRow As Long
    
    ' Set worksheets
    Set wsTrade = ThisWorkbook.Sheets("TradeData")
    Set wsLogic = ThisWorkbook.Sheets("LogicTable")
    
    ' Create or reference "RecBreaks" sheet
    On Error Resume Next
    Set wsRecBreaks = ThisWorkbook.Sheets("RecBreaks")
    On Error GoTo 0
    
    If wsRecBreaks Is Nothing Then
        ' If "RecBreaks" sheet doesn't exist, create it
        Set wsRecBreaks = ThisWorkbook.Sheets.Add(After:=Sheets(Sheets.Count))
        wsRecBreaks.Name = "RecBreaks"
    End If
    
    ' Set column numbers based on headers
    tradeCounterpartyIDCol = WorksheetFunction.Match("Counterparty ID", wsTrade.Rows(1), 0)
    logicSDSCol = WorksheetFunction.Match("SDS", wsLogic.Rows(1), 0)
    tradeSettleLegalEntityCol = WorksheetFunction.Match("Settle Legal Entity", wsTrade.Rows(1), 0)
    logicEntityCol = WorksheetFunction.Match("Entity", wsLogic.Rows(1), 0)
    
    ' Find the last rows in each sheet
    lastRowTrade = wsTrade.Cells(wsTrade.Rows.Count, tradeCounterpartyIDCol).End(xlUp).Row
    lastRowLogic = wsLogic.Cells(wsLogic.Rows.Count, logicSDSCol).End(xlUp).Row
    
    ' Initialize row number for "RecBreaks" sheet
    recBreaksRow = 1
    
    ' Loop through TradeData sheet
    For i = 2 To lastRowTrade
        ' Loop through LogicTable sheet
        For j = 2 To lastRowLogic
            ' Check if Counterparty ID matches SDS
            If wsTrade.Cells(i, tradeCounterpartyIDCol).Value = wsLogic.Cells(j, logicSDSCol).Value Then
                ' If match, check if Settle Legal Entity matches Entity
                If wsTrade.Cells(i, tradeSettleLegalEntityCol).Value <> wsLogic.Cells(j, logicEntityCol).Value Then
                    ' If not matching, copy the entire row to RecBreaks sheet
                    wsTrade.Rows(i).Copy Destination:=wsRecBreaks.Rows(recBreaksRow)
                    recBreaksRow = recBreaksRow + 1
                End If
                Exit For ' Exit inner loop after matching Counterparty ID
            End If
        Next j
    Next i
    
    MsgBox "Comparison and copying to RecBreaks complete!", vbInformation

End Sub
