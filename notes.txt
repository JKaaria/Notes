Sub AnalyseRatings()
    Dim wsAllOfferings As Worksheet
    Dim wsOverview As Worksheet
    Dim lastRow As Long
    Dim uniqueRegTypes As Collection
    Dim regType As Variant
    Dim totalSP As Double, totalMoody As Double, totalFitch As Double
    Dim countSP As Long, countMoody As Long, countFitch As Long
    Dim i As Long
    
    ' Set worksheets
    Set wsAllOfferings = ThisWorkbook.Sheets("All Offerings")
    Set wsOverview = ThisWorkbook.Sheets("Overview")
    
    ' Clear previous data in Overview sheet
    wsOverview.Range("I:O").Clear
    
    ' Find the last row in All Offerings sheet
    lastRow = wsAllOfferings.Cells(wsAllOfferings.Rows.Count, "A").End(xlUp).Row
    
    ' Initialize collections
    Set uniqueRegTypes = New Collection
    
    ' Loop through All Offerings sheet to gather unique regulatory types
    On Error Resume Next
    For i = 2 To lastRow ' Assuming headers are in row 1
        uniqueRegTypes.Add wsAllOfferings.Cells(i, "H").Value, CStr(wsAllOfferings.Cells(i, "H").Value)
    Next i
    On Error GoTo 0
    
    ' Loop through unique regulatory types and calculate averages
    For Each regType In uniqueRegTypes
        totalSP = 0
        totalMoody = 0
        totalFitch = 0
        countSP = 0
        countMoody = 0
        countFitch = 0
        
        For i = 2 To lastRow
            If CStr(wsAllOfferings.Cells(i, "H").Value) = regType Then
                If IsNumeric(wsAllOfferings.Cells(i, "I").Value) Then
                    totalSP = totalSP + wsAllOfferings.Cells(i, "I").Value
                    countSP = countSP + 1
                End If
                
                If IsNumeric(wsAllOfferings.Cells(i, "J").Value) Then
                    totalMoody = totalMoody + wsAllOfferings.Cells(i, "J").Value
                    countMoody = countMoody + 1
                End If
                
                If IsNumeric(wsAllOfferings.Cells(i, "K").Value) Then
                    totalFitch = totalFitch + wsAllOfferings.Cells(i, "K").Value
                    countFitch = countFitch + 1
                End If
            End If
        Next i
        
        ' Write results to Overview sheet
        wsOverview.Cells(wsOverview.Rows.Count, "I").End(xlUp).Offset(1, 0).Value = regType
        wsOverview.Cells(wsOverview.Rows.Count, "J").End(xlUp).Offset(1, 0).Value = IIf(countSP > 0, totalSP / countSP, 0)
        wsOverview.Cells(wsOverview.Rows.Count, "K").End(xlUp).Offset(1, 0).Value = IIf(countMoody > 0, totalMoody / countMoody, 0)
        wsOverview.Cells(wsOverview.Rows.Count, "L").End(xlUp).Offset(1, 0).Value = IIf(countFitch > 0, totalFitch / countFitch, 0)
    Next regType
End Sub
