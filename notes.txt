Sub AnalyseRatings()
    ' Define variables
    Dim wsAllOfferings As Worksheet
    Dim wsOverview As Worksheet
    Dim lastRow As Long
    Dim i As Long
    Dim regTypeDict As Object
    Dim ratingSumDict As Object
    Dim ratingCountDict As Object
    Dim regTypeCountDict As Object
    
    ' Set references to worksheets
    Set wsAllOfferings = ThisWorkbook.Sheets("All Offerings")
    Set wsOverview = ThisWorkbook.Sheets("Overview")
    
    ' Find the last row in All Offerings sheet
    lastRow = wsAllOfferings.Cells(wsAllOfferings.Rows.Count, "A").End(xlUp).Row
    
    ' Initialize dictionaries
    Set regTypeDict = CreateObject("Scripting.Dictionary")
    Set ratingSumDict = CreateObject("Scripting.Dictionary")
    Set ratingCountDict = CreateObject("Scripting.Dictionary")
    Set regTypeCountDict = CreateObject("Scripting.Dictionary")
    
    ' Loop through All Offerings data
    For i = 2 To lastRow ' Assuming row 1 is header
        ' Extract data from the current row
        Dim regType As String
        Dim clientCategory As String
        Dim spRating As String
        Dim moodyRating As String
        Dim fitchRating As String
        
        regType = wsAllOfferings.Cells(i, "I").Value
        clientCategory = wsAllOfferings.Cells(i, "H").Value
        spRating = wsAllOfferings.Cells(i, "I").Value
        moodyRating = wsAllOfferings.Cells(i, "J").Value
        fitchRating = wsAllOfferings.Cells(i, "K").Value
        
        ' Update dictionaries
        If Not regTypeDict.Exists(clientCategory) Then
            regTypeDict(clientCategory) = regType
        End If
        
        If Not ratingSumDict.Exists(clientCategory & "_" & spRating) Then
            ratingSumDict(clientCategory & "_" & spRating) = 0
            ratingCountDict(clientCategory & "_" & spRating) = 0
        End If
        
        If Not ratingSumDict.Exists(clientCategory & "_" & moodyRating) Then
            ratingSumDict(clientCategory & "_" & moodyRating) = 0
            ratingCountDict(clientCategory & "_" & moodyRating) = 0
        End If
        
        If Not ratingSumDict.Exists(clientCategory & "_" & fitchRating) Then
            ratingSumDict(clientCategory & "_" & fitchRating) = 0
            ratingCountDict(clientCategory & "_" & fitchRating) = 0
        End If
        
        ratingSumDict(clientCategory & "_" & spRating) = ratingSumDict(clientCategory & "_" & spRating) + wsAllOfferings.Cells(i, "I").Value
        ratingSumDict(clientCategory & "_" & moodyRating) = ratingSumDict(clientCategory & "_" & moodyRating) + wsAllOfferings.Cells(i, "J").Value
        ratingSumDict(clientCategory & "_" & fitchRating) = ratingSumDict(clientCategory & "_" & fitchRating) + wsAllOfferings.Cells(i, "K").Value
        
        ratingCountDict(clientCategory & "_" & spRating) = ratingCountDict(clientCategory & "_" & spRating) + 1
        ratingCountDict(clientCategory & "_" & moodyRating) = ratingCountDict(clientCategory & "_" & moodyRating) + 1
        ratingCountDict(clientCategory & "_" & fitchRating) = ratingCountDict(clientCategory & "_" & fitchRating) + 1
        
        If Not regTypeCountDict.Exists(clientCategory & "_" & regType) Then
            regTypeCountDict(clientCategory & "_" & regType) = 0
        End If
        
        regTypeCountDict(clientCategory & "_" & regType) = regTypeCountDict(clientCategory & "_" & regType) + 1
    Next i
    
    ' Output data to Overview sheet
    wsOverview.Cells.Clear
    
    ' Copy headers from All Offerings to Overview
    wsOverview.Range("A1:AI1").Value = wsAllOfferings.Range("A1:AI1").Value
    
    ' Write headers for the analysis
    wsOverview.Cells(1, 35).Value = "Average Rating by Agency"
    wsOverview.Cells(1, 36).Value = "Average Rating by Reg Type"
    
    ' Loop through unique client regulatory category codes
    Dim uniqueClientCategories As Variant
    uniqueClientCategories = regTypeDict.Keys
    
    For i = 0 To UBound(uniqueClientCategories)
        Dim clientCategoryKey As String
        clientCategoryKey = uniqueClientCategories(i)
        
        ' Extract values from dictionaries
        Dim spSum As Double
        Dim moodySum As Double
        Dim fitchSum As Double
        Dim spCount As Long
        Dim moodyCount As Long
        Dim fitchCount As Long
        
        spSum = ratingSumDict(clientCategoryKey & "_" & "S and P")
        moodySum = ratingSumDict(clientCategoryKey & "_" & "Moody")
        fitchSum = ratingSumDict(clientCategoryKey & "_" & "Fitch")
        
        spCount = ratingCountDict(clientCategoryKey & "_" & "S and P")
        moodyCount = ratingCountDict(clientCategoryKey & "_" & "Moody")
        fitchCount = ratingCountDict(clientCategoryKey & "_" & "Fitch")
        
        ' Calculate averages
        Dim spAverage As Double
        Dim moodyAverage As Double
        Dim fitchAverage As Double
        
        If spCount > 0 Then
            spAverage = spSum / spCount
        End If
        
        If moodyCount > 0 Then
            moodyAverage = moodySum / moodyCount
        End If
        
        If fitchCount > 0 Then
            fitchAverage = fitchSum / fitchCount
        End If
        
        ' Write data to Overview sheet
        wsOverview.Cells(i + 2, 35).Value = clientCategoryKey
        wsOverview.Cells(i + 2, 36).Value = regTypeDict(clientCategoryKey)
        wsOverview.Cells(i + 2, 37).Value = IIf(spCount > 0, spAverage, "")
        wsOverview.Cells(i + 2, 38).Value = IIf(moodyCount > 0, moodyAverage, "")
        wsOverview.Cells(i + 2, 39).Value = IIf(fitchCount > 0, fitchAverage, "")
    Next i
End Sub
