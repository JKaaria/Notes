Sub GenerateResultsSheet()
    Dim wsTrade As Worksheet
    Dim wsLogic As Worksheet
    Dim wsResults As Worksheet
    Dim lastRowTrade As Long
    Dim lastRowResults As Long
    Dim counterpartyIdCol As Integer
    Dim accountLegalNameCol As Integer
    Dim tradeIdCol As Integer
    Dim quantityCol As Integer
    Dim securityDescriptionCol As Integer
    Dim settleDateCol As Integer
    Dim settleLegalEntityCol As Integer
    Dim logicCounterpartyIdCol As Integer
    Dim logicSettleLegalEntityCol As Integer
    Dim i As Long, j As Long
    
    ' Set worksheets
    On Error Resume Next ' Ignore errors if sheet doesn't exist
    Set wsResults = ThisWorkbook.Sheets("ResultsSheet")
    On Error GoTo 0
    
    ' Create ResultsSheet if not already created
    If wsResults Is Nothing Then
        Set wsResults = Sheets.Add(After:=Sheets(Sheets.Count))
        wsResults.Name = "ResultsSheet"
    End If
    
    Set wsTrade = ThisWorkbook.Sheets("TradeData")
    Set wsLogic = ThisWorkbook.Sheets("LogicTable")
    
    ' Set column numbers based on headers in TradeData
    counterpartyIdCol = WorksheetFunction.Match("Counterparty ID", wsTrade.Rows(1), 0)
    accountLegalNameCol = WorksheetFunction.Match("Account Legal Name", wsTrade.Rows(1), 0)
    tradeIdCol = WorksheetFunction.Match("Trade ID", wsTrade.Rows(1), 0)
    quantityCol = WorksheetFunction.Match("Quantity", wsTrade.Rows(1), 0)
    securityDescriptionCol = WorksheetFunction.Match("Security Description", wsTrade.Rows(1), 0)
    settleDateCol = WorksheetFunction.Match("Settle Date", wsTrade.Rows(1), 0)
    settleLegalEntityCol = WorksheetFunction.Match("Settle Legal Entity", wsTrade.Rows(1), 0)
    
    ' Set column numbers based on headers in LogicTable
    logicCounterpartyIdCol = WorksheetFunction.Match("Counterparty ID", wsLogic.Rows(1), 0)
    logicSettleLegalEntityCol = WorksheetFunction.Match("Settle Legal Entity", wsLogic.Rows(1), 0)
    
    ' Find the last row in each sheet
    lastRowTrade = wsTrade.Cells(wsTrade.Rows.Count, counterpartyIdCol).End(xlUp).Row
    lastRowResults = wsResults.Cells(wsResults.Rows.Count, counterpartyIdCol).End(xlUp).Row + 1
    
    ' Loop through each row in TradeData
    For i = 2 To lastRowTrade
        ' Check if Counterparty ID starts with "US912..."
        If UCase(Left(wsTrade.Cells(i, counterpartyIdCol).Value, 6)) = "US912..." Then
            ' Copy specified columns to ResultsSheet
            wsTrade.Range(wsTrade.Cells(i, counterpartyIdCol), wsTrade.Cells(i, settleLegalEntityCol)).Copy _
                Destination:=wsResults.Range("A" & lastRowResults)
            lastRowResults = lastRowResults + 1
        End If
    Next i
    
    ' Loop through each row in ResultsSheet
    For i = 2 To lastRowResults - 1
        ' Loop through each row in LogicTable
        For j = 2 To wsLogic.Cells(wsLogic.Rows.Count, logicCounterpartyIdCol).End(xlUp).Row
            ' Check if Counterparty ID matches in LogicTable
            If wsResults.Cells(i, 1).Value = wsLogic.Cells(j, logicCounterpartyIdCol).Value Then
                ' Add corresponding value to ResultsSheet
                wsResults.Cells(i, lastRowResults).Value = wsLogic.Cells(j, logicSettleLegalEntityCol).Value
                Exit For ' Exit inner loop after matching
            End If
        Next j
    Next i
    
    MsgBox "ResultsSheet generated successfully!", vbInformation
End Sub
