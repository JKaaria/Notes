Sub GenerateEmails()
    Dim ws As Worksheet
    Dim failCodeColumn As Range
    Dim failDescriptionColumn As Range
    Dim lastRow As Long
    Dim i As Long
    Dim outlookApp As Object
    Dim outlookMail As Object

    ' Set the worksheet variable
    Set ws = ThisWorkbook.Sheets("AFT")

    ' Find the header row and locate the "Fail Code" and "Fail Description" columns
    On Error Resume Next
    Set failCodeColumn = ws.Rows(1).Find(What:="Fail Code", LookIn:=xlValues, LookAt:=xlWhole)
    Set failDescriptionColumn = ws.Rows(1).Find(What:="Fail Description", LookIn:=xlValues, LookAt:=xlWhole)
    On Error GoTo 0

    ' Check if the "Fail Code" and "Fail Description" columns are found
    If Not (failCodeColumn Is Nothing Or failDescriptionColumn Is Nothing) Then
        ' Find the last row in the "Fail Code" column
        lastRow = ws.Cells(ws.Rows.Count, failCodeColumn.Column).End(xlUp).Row

        ' Loop through each row in the "Fail Code" column
        For i = 2 To lastRow ' Assuming data starts from row 2

            ' Get the values from specified columns
            Dim tradeDate As Variant
            Dim ps As Variant
            Dim price As Variant
            Dim valueDate As Variant
            Dim nominal As Variant
            Dim ticket As Variant
            Dim instrumentID As Variant
            Dim instrument As Variant
            Dim accruedInterest As Variant
            Dim netProceeds As Variant
            Dim failDescription As Variant
            Dim salespersonName As Variant
            Dim crestID As Variant

            ' Assign values from the row to variables
            tradeDate = ws.Cells(i, ws.Rows(1).Find(What:="Trade Date").Column).Value
            ps = ws.Cells(i, ws.Rows(1).Find(What:="P/S").Column).Value
            price = ws.Cells(i, ws.Rows(1).Find(What:="Price").Column).Value
            valueDate = ws.Cells(i, ws.Rows(1).Find(What:="Value Date").Column).Value
            nominal = ws.Cells(i, ws.Rows(1).Find(What:="Nominal").Column).Value
            ticket = ws.Cells(i, ws.Rows(1).Find(What:="Ticket").Column).Value
            instrumentID = ws.Cells(i, ws.Rows(1).Find(What:="Instrument ID").Column).Value
            instrument = ws.Cells(i, ws.Rows(1).Find(What:="Instrument").Column).Value
            accruedInterest = ws.Cells(i, ws.Rows(1).Find(What:="Accrued Interest").Column).Value
            netProceeds = ws.Cells(i, ws.Rows(1).Find(What:="Net Proceeds").Column).Value
            failDescription = ws.Cells(i, failDescriptionColumn.Column).Value
            salespersonName = ws.Cells(i, ws.Rows(1).Find(What:="Salesperson Name").Column).Value
            crestID = ws.Cells(i, ws.Rows(1).Find(What:="Crest ID").Column).Value

            ' Create email body
            Dim emailBody As String
            emailBody = "Trade Date: " & tradeDate & vbCrLf _
                      & "P/S: " & ps & vbCrLf _
                      & "Price: " & price & vbCrLf _
                      & "Value Date: " & valueDate & vbCrLf _
                      & "Nominal: " & nominal & vbCrLf _
                      & "Ticket: " & ticket & vbCrLf _
                      & "Instrument ID: " & instrumentID & vbCrLf _
                      & "Instrument: " & instrument & vbCrLf _
                      & "Accrued Interest: " & accruedInterest & vbCrLf _
                      & "Net Proceeds: " & netProceeds & vbCrLf _
                      & "Fail Description: " & failDescription & vbCrLf _
                      & "Salesperson Name: " & salespersonName & vbCrLf _
                      & "Crest ID: " & crestID

            ' Create and display email
            Set outlookApp = CreateObject("Outlook.Application")
            Set outlookMail = outlookApp.CreateItem(0)
            With outlookMail
                .Subject = failDescription
                .Body = emailBody
                .Display
            End With

            ' Release Outlook objects
            Set outlookMail = Nothing
            Set outlookApp = Nothing
        Next i
    Else
        MsgBox "Column 'Fail Code' or 'Fail Description' not found in the worksheet."
    End If
End Sub




Sub GenerateCombinedEmail()
    Dim ws As Worksheet
    Dim failCodeColumn As Range
    Dim failDescriptionColumn As Range
    Dim lastRow As Long
    Dim i As Long
    Dim outlookApp As Object
    Dim outlookMail As Object

    ' Set the worksheet variable
    Set ws = ThisWorkbook.Sheets("AFT")

    ' Find the header row and locate the "Fail Code" and "Fail Description" columns
    On Error Resume Next
    Set failCodeColumn = ws.Rows(1).Find(What:="Fail Code", LookIn:=xlValues, LookAt:=xlWhole)
    Set failDescriptionColumn = ws.Rows(1).Find(What:="Fail Description", LookIn:=xlValues, LookAt:=xlWhole)
    On Error GoTo 0

    ' Check if the "Fail Code" and "Fail Description" columns are found
    If Not (failCodeColumn Is Nothing Or failDescriptionColumn Is Nothing) Then
        ' Find the last row in the "Fail Code" column
        lastRow = ws.Cells(ws.Rows.Count, failCodeColumn.Column).End(xlUp).Row

        ' Initialize variables for email content
        Dim emailSubject As String
        Dim emailBody As String
        emailSubject = ""
        emailBody = ""

        ' Loop through each row in the "Fail Code" column
        For i = 2 To lastRow ' Assuming data starts from row 2

            ' Check if the Fail Code is 102 or 133
            If ws.Cells(i, failCodeColumn.Column).Value = 102 Or ws.Cells(i, failCodeColumn.Column).Value = 133 Then
                ' If it's the first matching row, set the subject
                If emailSubject = "" Then
                    emailSubject = ws.Cells(i, failDescriptionColumn.Column).Value & " " & Format(Date, "YYYY-MM-DD")
                End If

                ' Accumulate information in the email body
                emailBody = emailBody & "Row " & i - 1 & ":" & vbCrLf
                emailBody = emailBody & "Trade Date: " & ws.Cells(i, ws.Rows(1).Find(What:="Trade Date").Column).Value & vbCrLf
                ' Include other columns as needed

                ' Add a separator between rows
                emailBody = emailBody & "-----------------------------" & vbCrLf
            End If
        Next i

        ' Check if any matching rows were found
        If emailSubject <> "" Then
            ' Create and display email
            Set outlookApp = CreateObject("Outlook.Application")
            Set outlookMail = outlookApp.CreateItem(0)
            With outlookMail
                .Subject = emailSubject
                .Body = emailBody
                .Display
            End With
        Else
            MsgBox "No rows found with Fail Code 102 or 133."
        End If
    Else
        MsgBox "Column 'Fail Code' or 'Fail Description' not found in the worksheet."
    End If
End Sub
