Sub AnalyseRatings()
    ' Declare variables
    Dim wsAllOfferings As Worksheet
    Dim wsOverview As Worksheet
    Dim lastRow As Long
    Dim uniqueCodes As Collection
    Dim code As Variant
    Dim totalSP As Double, totalMoody As Double, totalFitch As Double
    Dim countSP As Integer, countMoody As Integer, countFitch As Integer
    
    ' Set references to worksheets
    Set wsAllOfferings = ThisWorkbook.Sheets("All Offerings")
    Set wsOverview = ThisWorkbook.Sheets("Overview")
    
    ' Find the last row in the All Offerings sheet
    lastRow = wsAllOfferings.Cells(wsAllOfferings.Rows.Count, "H").End(xlUp).Row
    
    ' Initialize a collection to store unique codes
    Set uniqueCodes = New Collection
    
    ' Loop through the All Offerings sheet to collect unique codes
    For i = 2 To lastRow ' Assuming header is in row 1
        On Error Resume Next
        uniqueCodes.Add wsAllOfferings.Cells(i, 8).Value, CStr(wsAllOfferings.Cells(i, 8).Value)
        On Error GoTo 0
    Next i
    
    ' Loop through unique codes to analyze ratings
    For Each code In uniqueCodes
        ' Reset variables for each code
        totalSP = 0
        totalMoody = 0
        totalFitch = 0
        countSP = 0
        countMoody = 0
        countFitch = 0
        
        ' Loop through All Offerings to calculate totals and counts
        For i = 2 To lastRow
            If wsAllOfferings.Cells(i, 8).Value = code Then
                ' Check if S&P rating exists
                If Not IsEmpty(wsAllOfferings.Cells(i, 9).Value) Then
                    totalSP = totalSP + wsAllOfferings.Cells(i, 9).Value
                    countSP = countSP + 1
                End If
                
                ' Check if Moody's rating exists
                If Not IsEmpty(wsAllOfferings.Cells(i, 10).Value) Then
                    totalMoody = totalMoody + wsAllOfferings.Cells(i, 10).Value
                    countMoody = countMoody + 1
                End If
                
                ' Check if Fitch rating exists
                If Not IsEmpty(wsAllOfferings.Cells(i, 11).Value) Then
                    totalFitch = totalFitch + wsAllOfferings.Cells(i, 11).Value
                    countFitch = countFitch + 1
                End If
            End If
        Next i
        
        ' Calculate averages and update Overview sheet
        If countSP > 0 Then
            wsOverview.Cells(code, 9).Value = totalSP / countSP
        End If
        
        If countMoody > 0 Then
            wsOverview.Cells(code, 10).Value = totalMoody / countMoody
        End If
        
        If countFitch > 0 Then
            wsOverview.Cells(code, 11).Value = totalFitch / countFitch
        End If
    Next code
End Sub
