Sub AppendToConsolidatedWorkbook()
    Dim SourceFolderPath As String
    Dim ConsolidatedWorkbookPath As String
    Dim ConsolidatedWorkbook As Workbook
    Dim SourceWorkbook As Workbook
    Dim SourceWorksheet As Worksheet
    Dim SourceFile As String
    Dim FirstFile As Boolean
    Dim WorkbookIsOpen As Boolean
    Dim CurrentRow As Long
    
    ' Set the source folder path
    SourceFolderPath = ThisWorkbook.Path ' Use the folder where this workbook is located
    
    ' Set the path to the consolidated workbook
    ConsolidatedWorkbookPath = SourceFolderPath & "\ConsolidatedWorkbook.xlsm"
    
    ' Check if the consolidated workbook is already open
    On Error Resume Next
    Set ConsolidatedWorkbook = Workbooks("ConsolidatedWorkbook.xlsm")
    On Error GoTo 0
    
    ' If it's not open, open it
    If ConsolidatedWorkbook Is Nothing Then
        ' Check if the file exists
        If Dir(ConsolidatedWorkbookPath) = "" Then
            MsgBox "Consolidated workbook does not exist. Please create it first."
            Exit Sub
        End If
        ' Open the consolidated workbook
        Set ConsolidatedWorkbook = Workbooks.Open(ConsolidatedWorkbookPath)
        WorkbookIsOpen = False
    Else
        WorkbookIsOpen = True
    End If
    
    ' Initialize a variable to track if it's the first file
    FirstFile = True
    
    ' Loop through files in the folder
    SourceFile = Dir(SourceFolderPath & "\*.xls*")
    Do While SourceFile <> ""
        ' Check if it's not the consolidated workbook
        If SourceFile <> "ConsolidatedWorkbook.xlsm" Then
            ' Open the source workbook
            Set SourceWorkbook = Workbooks.Open(SourceFolderPath & "\" & SourceFile)
            
            ' Loop through worksheets in the source workbook
            For Each SourceWorksheet In SourceWorkbook.Sheets
                ' Check if it's the first worksheet to set column headers
                If FirstFile Then
                    SourceWorksheet.UsedRange.Copy Destination:=ConsolidatedWorkbook.Sheets(1).Cells(1, 1)
                    FirstFile = False
                    CurrentRow = ConsolidatedWorkbook.Sheets(1).Cells(Rows.Count, 1).End(xlUp).Row
                Else
                    ' Copy data from the second row onward to avoid duplicating the first row
                    SourceWorksheet.UsedRange.Offset(1, 0).Copy Destination:=ConsolidatedWorkbook.Sheets(1).Cells(CurrentRow + 1, 1)
                    CurrentRow = ConsolidatedWorkbook.Sheets(1).Cells(Rows.Count, 1).End(xlUp).Row
                End If
            Next SourceWorksheet
            
            ' Close the source workbook without saving changes
            SourceWorkbook.Close SaveChanges:=False
        End If
        
        ' Get the next file in the folder
        SourceFile = Dir
    Loop
    
    ' Save and close the consolidated workbook if it was opened by the script
    If Not WorkbookIsOpen Then
        ConsolidatedWorkbook.Save
        ConsolidatedWorkbook.Close SaveChanges:=False
    End If
End Sub