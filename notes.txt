Sub AnalyseRatings()
    Dim wsAllOfferings As Worksheet
    Dim wsOverview As Worksheet
    Dim lastRow As Long
    Dim i As Long
    Dim uniqueCodes As Collection
    Dim code As Variant
    Dim spTotal As Double, moodyTotal As Double, fitchTotal As Double
    Dim spCount As Long, moodyCount As Long, fitchCount As Long
    
    ' Set references to worksheets
    Set wsAllOfferings = ThisWorkbook.Sheets("All Offerings")
    Set wsOverview = ThisWorkbook.Sheets("Overview")
    
    ' Find the last row in All Offerings sheet
    lastRow = wsAllOfferings.Cells(wsAllOfferings.Rows.Count, "A").End(xlUp).Row
    
    ' Initialize collections and totals
    Set uniqueCodes = New Collection
    spTotal = 0
    moodyTotal = 0
    fitchTotal = 0
    spCount = 0
    moodyCount = 0
    fitchCount = 0
    
    ' Loop through each row in All Offerings sheet
    For i = 2 To lastRow ' Assuming headers are in row 1
        ' Get unique code from column H
        code = wsAllOfferings.Cells(i, 8).Text
        On Error Resume Next
        uniqueCodes.Add code, CStr(code)
        On Error GoTo 0
        
        ' Sum ratings based on the agency and reg type
        spTotal = spTotal + ConvertToDouble(wsAllOfferings.Cells(i, 9).Text)
        moodyTotal = moodyTotal + ConvertToDouble(wsAllOfferings.Cells(i, 10).Text)
        fitchTotal = fitchTotal + ConvertToDouble(wsAllOfferings.Cells(i, 11).Text)
        
        ' Count ratings based on the agency and reg type
        spCount = spCount + 1
        moodyCount = moodyCount + 1
        fitchCount = fitchCount + 1
    Next i
    
    ' Write results to Overview sheet
    wsOverview.Range("I2:I" & uniqueCodes.Count + 1).Value = Application.Transpose(uniqueCodes.Items)
    wsOverview.Range("J2").Formula = "=SUMIFS('All Offerings'!$I$2:$I$" & lastRow & ",'All Offerings'!$H$2:$H$" & lastRow & ",'Overview'!$I2)/COUNTIFS('All Offerings'!$H$2:$H$" & lastRow & ",'Overview'!$I2)"
    wsOverview.Range("K2").Formula = "=SUMIFS('All Offerings'!$J$2:$J$" & lastRow & ",'All Offerings'!$H$2:$H$" & lastRow & ",'Overview'!$I2)/COUNTIFS('All Offerings'!$H$2:$H$" & lastRow & ",'Overview'!$I2)"
    wsOverview.Range("J3").Formula = "=AVERAGE('All Offerings'!$I$2:$I$" & lastRow & ")"
    wsOverview.Range("K3").Formula = "=AVERAGE('All Offerings'!$J$2:$J$" & lastRow & ")"
    
    ' Clean up
    Set uniqueCodes = Nothing
End Sub

Function ConvertToDouble(value As Variant) As Double
    On Error Resume Next
    ConvertToDouble = CDbl(value)
    On Error GoTo 0
End Function
