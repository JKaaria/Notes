Sub Three()
    Dim wsTradeData As Worksheet
    Dim wsLogicTable As Worksheet
    Dim counterpartyColumn As Range
    Dim washRealignCodeColumn As Range
    Dim cell As Range
    Dim exceptionList As String

    ' Set references to sheets
    Set wsTradeData = ThisWorkbook.Sheets("CBCreditTrades")
    Set wsLogicTable = ThisWorkbook.Sheets("CBLogicTable")

    ' Find column indices in TradeData sheet
    Set counterpartyColumn = wsTradeData.Rows(1).Find("Counterparty")
    Set washRealignCodeColumn = wsTradeData.Rows(1).Find("Wash Realign Code")

    If counterpartyColumn Is Nothing Or washRealignCodeColumn Is Nothing Then
        MsgBox "Column headers not found in TradeData sheet."
        Exit Sub
    End If

    ' List of clients to check
    Dim clientsToCheck As Variant
    clientsToCheck = Array("AFRICAN DEV BK", "BIS-BIS_PEND", "BK INTL SETTLEMENTS", "BK of TH-General", "BK OF THAILAND", _
                           "BK of TH-Currency", "NARODOWY BANK POLSKI", "NATIONAL PEN SERVICE", "KOOKMIN BK CO LTD-LO", _
                           "CENTRAL BANK OF UAE", "QATAR CENTAL BANK", "BAMK OF ISRAEL", "EU BK FOR R AND D", _
                           "NATL BK OF KASAKHSTAN")

    ' Initialize exception list
    exceptionList = ""

    ' Loop through Counterparty column in TradeData
    For Each cell In wsTradeData.Range(wsTradeData.Cells(2, counterpartyColumn.Column), wsTradeData.Cells(wsTradeData.Rows.Count, counterpartyColumn.Column).End(xlUp))
        ' Check if Counterparty is in the list
        If IsInArray(cell.Value, clientsToCheck) Then
            ' Find corresponding row in LogicTable
            Dim logicTableRow As Range
            Set logicTableRow = wsLogicTable.Columns(1).Find(cell.Value, LookIn:=xlValues)

            ' Check if LogicTable row is found
            If Not logicTableRow Is Nothing Then
                ' Check if there is a mismatch between Trade Id and Required Wash Realign Code
                If wsTradeData.Cells(cell.Row, wsTradeData.Rows(1).Find("Trade Id").Column).Value <> wsLogicTable.Cells(logicTableRow.Row, 1).Value _
                    Or wsTradeData.Cells(cell.Row, washRealignCodeColumn.Column).Value <> wsLogicTable.Cells(logicTableRow.Row, 3).Value Then

                    ' Add exception details to the list
                    exceptionList = exceptionList & "Trade Id: " & wsTradeData.Cells(cell.Row, wsTradeData.Rows(1).Find("Trade Id").Column).Value & vbCrLf & _
                                    "Counterparty: " & cell.Value & vbCrLf & _
                                    "Quantity: " & wsTradeData.Cells(cell.Row, wsTradeData.Rows(1).Find("Quantity").Column).Value & vbCrLf & _
                                    "Price: " & wsTradeData.Cells(cell.Row, wsTradeData.Rows(1).Find("Price").Column).Value & vbCrLf & _
                                    "Settle Date: " & wsTradeData.Cells(cell.Row, wsTradeData.Rows(1).Find("Settle Date").Column).Value & vbCrLf & _
                                    "ISIN: " & wsTradeData.Cells(cell.Row, wsTradeData.Rows(1).Find("ISIN").Column).Value & vbCrLf & _
                                    "Settle Legal Entity: " & wsTradeData.Cells(cell.Row, wsTradeData.Rows(1).Find("Settle Legal Entity").Column).Value & vbCrLf & _
                                    "Wash Realign Code: " & wsTradeData.Cells(cell.Row, washRealignCodeColumn.Column).Value & vbCrLf & _
                                    "Required Wash Realign Code: " & wsLogicTable.Cells(logicTableRow.Row, 3).Value & vbCrLf & vbCrLf
                End If
            Else
                ' Add exception details to the list if Counterparty not found in LogicTable
                exceptionList = exceptionList & "Trade Id: " & wsTradeData.Cells(cell.Row, wsTradeData.Rows(1).Find("Trade Id").Column).Value & vbCrLf & _
                                "Counterparty: " & cell.Value & vbCrLf & _
                                "Counterparty not found in LogicTable." & vbCrLf & _
                                "Settle Legal Entity: " & wsTradeData.Cells(cell.Row, wsTradeData.Rows(1).Find("Settle Legal Entity").Column).Value & vbCrLf & _
                                "Wash Realign Code: " & wsTradeData.Cells(cell.Row, washRealignCodeColumn.Column).Value & vbCrLf & vbCrLf
            End If
        End If
    Next cell

    ' Check if any exceptions were found
    If Len(exceptionList) > 0 Then
        ' Send email with exception details
        SendExceptionEmail exceptionList
    Else
        MsgBox "No exceptions found."
    End If
End Sub

