Sub GenerateCombinedEmail()
    Dim ws As Worksheet
    Dim failCodeColumn As Range
    Dim lastRow As Long
    Dim i As Long
    Dim outlookApp As Object
    Dim outlookMail As Object

    ' Set the worksheet variable
    Set ws = ThisWorkbook.Sheets("AFT")

    ' Find the header row and locate the "Fail Code" column
    On Error Resume Next
    Set failCodeColumn = ws.Rows(1).Find(What:="Fail Code", LookIn:=xlValues, LookAt:=xlWhole)
    On Error GoTo 0

    ' Check if the "Fail Code" column is found
    If Not failCodeColumn Is Nothing Then
        ' Find the last row in the "Fail Code" column
        lastRow = ws.Cells(ws.Rows.Count, failCodeColumn.Column).End(xlUp).Row

        ' Initialize variables for email content
        Dim emailSubject As String
        Dim emailBody As String
        emailSubject = ""
        emailBody = ""

        ' Loop through each row in the "Fail Code" column
        For i = 2 To lastRow ' Assuming data starts from row 2

            ' Check if the Fail Code is 102 or 133
            If ws.Cells(i, failCodeColumn.Column).Value = 102 Or ws.Cells(i, failCodeColumn.Column).Value = 133 Then
                ' If it's the first matching row, set the subject
                If emailSubject = "" Then
                    emailSubject = "Fail Code " & ws.Cells(i, failCodeColumn.Column).Value
                End If

                ' Accumulate information in the email body
                emailBody = emailBody & "Row " & i - 1 & ":" & vbCrLf
                emailBody = emailBody & "Trade Date: " & ws.Cells(i, ws.Rows(1).Find(What:="Trade Date").Column).Value & vbCrLf
                ' Include other columns as needed

                ' Add a separator between rows
                emailBody = emailBody & "-----------------------------" & vbCrLf
            End If
        Next i

        ' Check if any matching rows were found
        If emailSubject <> "" Then
            ' Create and display email
            Set outlookApp = CreateObject("Outlook.Application")
            Set outlookMail = outlookApp.CreateItem(0)
            With outlookMail
                .Subject = emailSubject
                .Body = emailBody
                .Display
            End With
        Else
            MsgBox "No rows found with Fail Code 102 or 133."
        End If
    Else
        MsgBox "Column 'Fail Code' not found in the worksheet."
    End If
End Sub

