Sub CheckTradeDataAndSendEmail()
    Dim wsTradeData As Worksheet
    Dim wsLogicTable As Worksheet
    Dim counterpartyColumn As Range
    Dim washRealignCodeColumn As Range
    Dim cell As Range
    Dim exceptionList As String

    ' Set references to sheets
    Set wsTradeData = ThisWorkbook.Sheets("TradeData")
    Set wsLogicTable = ThisWorkbook.Sheets("LogicTable")

    ' Find column indices in TradeData sheet
    Set counterpartyColumn = wsTradeData.Rows(1).Find("Counterparty")
    Set washRealignCodeColumn = wsTradeData.Rows(1).Find("Wash Realign Code")

    If counterpartyColumn Is Nothing Or washRealignCodeColumn Is Nothing Then
        MsgBox "Column headers not found in TradeData sheet."
        Exit Sub
    End If

    ' List of clients to check
    Dim clientsToCheck As Variant
    clientsToCheck = Array("AFRICAN DEV BK", "BIS-BIS_PEND", "BK INTL SETTLEMENTS", "BK of TH-General", "BK OF THAILAND", _
                           "BK of TH-Currency", "NARODOWY BANK POLSKI", "NATIONAL PEN SERVICE", "KOOKMIN BK CO LTD-LO", _
                           "CENTRAL BANK OF UAE", "QATAR CENTAL BANK", "BAMK OF ISRAEL", "EU BK FOR R AND D", _
                           "NATL BK OF KASAKHSTAN")

    ' Initialize exception list
    exceptionList = ""

    ' Loop through Counterparty column in TradeData
    For Each cell In wsTradeData.Range(wsTradeData.Cells(2, counterpartyColumn.Column), wsTradeData.Cells(wsTradeData.Rows.Count, counterpartyColumn.Column).End(xlUp))
        ' Check if Counterparty is in the list
        If IsInArray(cell.Value, clientsToCheck) Then
            ' Find corresponding row in LogicTable
            Dim logicTableRow As Range
            Set logicTableRow = wsLogicTable.Columns(1).Find(cell.Value, LookIn:=xlValues)

            ' Check if LogicTable row is found
            If Not logicTableRow Is Nothing Then
                ' Check if Wash Realign Code matches
                If wsTradeData.Cells(cell.Row, washRealignCodeColumn.Column).Value <> wsLogicTable.Cells(logicTableRow.Row, 2).Value Then
                    ' Add exception details to the list
                    exceptionList = exceptionList & "Trade Id: " & wsTradeData.Cells(cell.Row, wsTradeData.Rows(1).Find("Trade Id").Column).Value & vbCrLf & _
                                    "Counterparty: " & cell.Value & vbCrLf & _
                                    "Quantity: " & wsTradeData.Cells(cell.Row, wsTradeData.Rows(1).Find("Quantity").Column).Value & vbCrLf & _
                                    "Price: " & wsTradeData.Cells(cell.Row, wsTradeData.Rows(1).Find("Price").Column).Value & vbCrLf & _
                                    "Settle Date: " & wsTradeData.Cells(cell.Row, wsTradeData.Rows(1).Find("Settle Date").Column).Value & vbCrLf & _
                                    "ISIN: " & wsTradeData.Cells(cell.Row, wsTradeData.Rows(1).Find("ISIN").Column).Value & vbCrLf & _
                                    "Correct Wash Realign Code: " & wsLogicTable.Cells(logicTableRow.Row, 2).Value & vbCrLf & vbCrLf
                End If
            Else
                ' Add exception details to the list if Counterparty not found in LogicTable
                exceptionList = exceptionList & "Trade Id: " & wsTradeData.Cells(cell.Row, wsTradeData.Rows(1).Find("Trade Id").Column).Value & vbCrLf & _
                                "Counterparty: " & cell.Value & vbCrLf & _
                                "Counterparty not found in LogicTable." & vbCrLf & vbCrLf
            End If
        End If
    Next cell

    ' Check if any exceptions were found
    If Len(exceptionList) > 0 Then
        ' Send email with exception details
        SendExceptionEmail exceptionList
    Else
        MsgBox "No exceptions found."
    End If
End Sub

Sub SendExceptionEmail(exceptionList As String)
    Dim outlookApp As Object
    Dim outlookMail As Object

    ' Create Outlook Application
    Set outlookApp = CreateObject("Outlook.Application")
    Set outlookMail = outlookApp.CreateItem(0)

    ' Set email properties
    With outlookMail
        .To = "recipient@example.com" ' Replace with the recipient's email address
        .Subject = "Trade Data Exceptions"
        .Body = "The following exceptions were found in the Trade Data:" & vbCrLf & vbCrLf & exceptionList
        .Display ' Display email for review before sending
        '.Send ' Uncomment this line to send the email automatically
    End With

    ' Clean up
    Set outlookMail = Nothing
    Set outlookApp = Nothing
End Sub

Function IsInArray(stringToBeFound As String, arr As Variant) As Boolean
    Dim element As Variant
    For Each element In arr
        If element = stringToBeFound Then
            IsInArray = True
            Exit Function
        End If
    Next element
    IsInArray = False
End Function