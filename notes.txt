Sub MergeDataFromDelphiAndTmp()
    Dim wb As Workbook
    Dim wsDelphi As Worksheet
    Dim wsTmp As Worksheet
    Dim wsFails As Worksheet
    Dim lastRowDelphi As Long
    Dim lastRowTmp As Long
    Dim i As Long, j As Long
    Dim matchFound As Boolean
    
    ' Set references to the active workbook and worksheets
    Set wb = ThisWorkbook
    Set wsDelphi = Nothing
    Set wsTmp = Nothing
    
    ' Look for "Delphi" and "Tmp" worksheets in the active workbook
    For Each ws In wb.Worksheets
        If ws.Name Like "Delphi*" Then
            Set wsDelphi = ws
        ElseIf ws.Name Like "Tmp*" Then
            Set wsTmp = ws
        End If
    Next ws
    
    ' Check if both source worksheets were found
    If wsDelphi Is Nothing Or wsTmp Is Nothing Then
        MsgBox "Source worksheets not found."
        Exit Sub
    End If
    
    ' Set reference to the "Fails" worksheet in the active workbook
    On Error Resume Next
    Set wsFails = wb.Worksheets("Fails")
    On Error GoTo 0
    
    ' Check if the "Fails" worksheet exists, create it if not
    If wsFails Is Nothing Then
        Set wsFails = wb.Worksheets.Add
        wsFails.Name = "Fails"
    End If
    
    ' Find the last row in each source sheet
    lastRowDelphi = wsDelphi.Cells(wsDelphi.Rows.Count, "A").End(xlUp).Row
    lastRowTmp = wsTmp.Cells(wsTmp.Rows.Count, "A").End(xlUp).Row
    
    ' Initialize a flag to check for matches
    matchFound = False
    
    ' Loop through the Delphi sheet
    For i = 2 To lastRowDelphi ' Assuming headers are in row 1
        matchFound = False
        ' Loop through the Tmp sheet
        For j = 2 To lastRowTmp ' Assuming headers are in row 1
            ' Check if there is a match based on "External Trade ID"
            If wsDelphi.Cells(i, "A").Value = wsTmp.Cells(j, "Ticket").Value Then
                ' Copy data from Tmp to Fails
                wsTmp.Rows(j).Copy wsFails.Rows(i)
                matchFound = True
                Exit For ' Exit the Tmp loop once a match is found
            End If
        Next j
    Next i
    
    ' Inform the user about the result
    If matchFound Then
        MsgBox "Data merged successfully."
    Else
        MsgBox "No matching data found to merge."
    End If
End Sub
