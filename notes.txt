Sub CheckAndEmailMismatchedEntities()
    Dim wsTrade As Worksheet
    Dim wsLogic As Worksheet
    Dim lastRowTrade As Long
    Dim counterpartyIDCol As Range
    Dim logicCounterpartyCol As Range
    Dim settleLegalEntityCol As Range
    Dim emailBody As String
    Dim outlookApp As Object
    Dim outlookMail As Object
    
    ' Set worksheets
    Set wsTrade = ThisWorkbook.Sheets("TradeData") ' Replace "TradeData" with the actual name of your sheet
    Set wsLogic = ThisWorkbook.Sheets("LogicTable") ' Replace "LogicTable" with the actual name of your sheet
    
    ' Find column numbers based on headers
    Set counterpartyIDCol = wsTrade.Rows(1).Find("Counterparty ID", LookIn:=xlValues, LookAt:=xlWhole)
    Set logicCounterpartyCol = wsLogic.Rows(1).Find("Counterparty ID", LookIn:=xlValues, LookAt:=xlWhole)
    Set settleLegalEntityCol = wsTrade.Rows(1).Find("Settle Legal Entity", LookIn:=xlValues, LookAt:=xlWhole)
    
    ' Check if headers are found
    If Not counterpartyIDCol Is Nothing And Not logicCounterpartyCol Is Nothing And Not settleLegalEntityCol Is Nothing Then
        ' Find the last row in the TradeData sheet
        lastRowTrade = wsTrade.Cells(wsTrade.Rows.Count, counterpartyIDCol.Column).End(xlUp).Row
        
        ' Initialize email body
        emailBody = "Mismatched Entities Details:" & vbCrLf & vbCrLf
        
        ' Loop through each row in the TradeData sheet
        For i = 2 To lastRowTrade
            ' Check if Counterparty ID is found in LogicTable sheet
            If Not IsEmpty(wsTrade.Cells(i, counterpartyIDCol.Column).Value) Then
                If WorksheetFunction.CountIf(wsLogic.Columns(logicCounterpartyCol.Column), wsTrade.Cells(i, counterpartyIDCol.Column).Value) > 0 Then
                    ' Check if Settle Legal Entity matches
                    If wsTrade.Cells(i, settleLegalEntityCol.Column).Value <> wsLogic.Cells(Application.Match(wsTrade.Cells(i, counterpartyIDCol.Column).Value, wsLogic.Columns(logicCounterpartyCol.Column), 0), logicSettleLegalEntityCol.Column).Value Then
                        ' Add details of mismatching row to email body
                        emailBody = emailBody & "Row " & i & ": Mismatched Settle Legal Entity." & vbCrLf &
                                     "Counterparty ID: " & wsTrade.Cells(i, counterpartyIDCol.Column).Value & vbCrLf &
                                     "Settle Legal Entity (TradeData): " & wsTrade.Cells(i, settleLegalEntityCol.Column).Value & vbCrLf &
                                     "Settle Legal Entity (LogicTable): " & wsLogic.Cells(Application.Match(wsTrade.Cells(i, counterpartyIDCol.Column).Value, wsLogic.Columns(logicCounterpartyCol.Column), 0), logicSettleLegalEntityCol.Column).Value & vbCrLf & vbCrLf
                    End If
                End If
            End If
        Next i
        
        ' Create Outlook Application
        Set outlookApp = CreateObject("Outlook.Application")
        
        ' Create a new mail item
        Set outlookMail = outlookApp.CreateItem(0)
        
        ' Customize email properties
        With outlookMail
            .Subject = "Mismatched Entities Report"
            .Body = emailBody
            ' Add recipient's email address
            .Recipients.Add "recipient@example.com" ' Add recipient's email address
            .Display
        End With
        
        ' Release Outlook objects
        Set outlookMail = Nothing
        Set outlookApp = Nothing
    Else
        MsgBox "One or more required headers not found.", vbExclamation
    End If
End Sub