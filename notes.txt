Sub CrossReferenceAndDeleteRows()
    Dim tradeDataSheet As Worksheet
    Dim ssiaffirmationSheet As Worksheet
    Dim tradeDataLastRow As Long
    Dim ssiaffirmationLastRow As Long
    Dim i As Long, j As Long

    ' Set the sheets
    Set tradeDataSheet = ThisWorkbook.Sheets("TradeData")
    Set ssiaffirmationSheet = ThisWorkbook.Sheets("SSIAffirmation")

    ' Find the last row with data in each sheet
    tradeDataLastRow = tradeDataSheet.Cells(tradeDataSheet.Rows.Count, "B").End(xlUp).Row
    ssiaffirmationLastRow = ssiaffirmationSheet.Cells(ssiaffirmationSheet.Rows.Count, "B").End(xlUp).Row

    ' Loop through TradeData sheet
    For i = tradeDataLastRow To 2 Step -1 ' Start from the last row to avoid issues with row deletion
        Dim tradeDataValue As Variant
        tradeDataValue = tradeDataSheet.Cells(i, "BI").Value

        ' Check if the value is not found in SSIAffirmation sheet
        If IsError(Application.Match(tradeDataValue, ssiaffirmationSheet.Range("B2:B" & ssiaffirmationLastRow), 0)) Then
            ' If not found, delete the row in TradeData sheet
            tradeDataSheet.Rows(i).Delete
        End If
    Next i

    ' Loop through TradeData sheet again to add the formula
    tradeDataLastRow = tradeDataSheet.Cells(tradeDataSheet.Rows.Count, "B").End(xlUp).Row ' Update the last row after deletion
    For i = 2 To tradeDataLastRow
        If Not IsEmpty(tradeDataSheet.Cells(i, "B").Value) Then
            tradeDataSheet.Cells(i, "A").Formula = "=IF(CC" & i & "=" & "PLC_WASH, DTC 2196 or CBL 34797, IF(CC" & i & "=" & "POLARITE, DTC 7256 or CBL 15996, IF(CG" & i & "=" & "BREXIT, DTC____ or CBL 21864, IF(CC" & i & "=" & "IMP_LNBR, DTC 7254 or CBL 34797, IF(BF" & i & "=" & "LNBR, DTC 7254 or CBL 34797, DTC 7256 or CBL 15996))))"
        End If
    Next i

    ' Clean up
    Set tradeDataSheet = Nothing
    Set ssiaffirmationSheet = Nothing
End Sub
