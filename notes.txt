Sub MergeDataFromAllWorkbooks()
    Dim CurrentFolderPath As String
    Dim SourceWorkbook As Workbook
    Dim TargetWorksheet As Worksheet
    Dim lastRowTarget As Long
    Dim lastRowSource As Long
    Dim i As Long, j As Long
    Dim matchFound As Boolean
    Dim SourceWorksheet As Worksheet
    
    ' Set the directory path where the source workbooks are located
    CurrentFolderPath = ThisWorkbook.Path
    
    ' Set reference to the "Fails" worksheet in the active workbook
    On Error Resume Next
    Set TargetWorksheet = ThisWorkbook.Worksheets("Fails")
    On Error GoTo 0
    
    ' Check if the "Fails" worksheet exists, create it if not
    If TargetWorksheet Is Nothing Then
        Set TargetWorksheet = ThisWorkbook.Worksheets.Add
        TargetWorksheet.Name = "Fails"
    End If
    
    ' Find the last row in the target worksheet
    lastRowTarget = TargetWorksheet.Cells(TargetWorksheet.Rows.Count, "A").End(xlUp).Row
    
    ' Loop through all files in the current folder
    Dim FileName As String
    FileName = Dir(CurrentFolderPath & "\*.xls*")
    
    Do While FileName <> ""
        ' Exclude the active workbook from processing
        If FileName <> ThisWorkbook.Name Then
            ' Open the source workbook
            Set SourceWorkbook = Workbooks.Open(CurrentFolderPath & "\" & FileName)
            
            ' Set reference to the first worksheet in the source workbook
            Set SourceWorksheet = SourceWorkbook.Sheets(1) ' Assuming data is on the first sheet
            
            ' Find the last row in the source sheet
            lastRowSource = SourceWorksheet.Cells(SourceWorksheet.Rows.Count, "A").End(xlUp).Row
            
            ' Initialize a flag to check for matches
            matchFound = False
            
            ' Loop through the source sheet
            For i = 2 To lastRowSource ' Assuming headers are in row 1
                matchFound = False
                ' Loop through the target worksheet
                For j = 2 To lastRowTarget ' Assuming headers are in row 1
                    ' Check if there is a match based on "External Trade ID" (modify as needed)
                    If SourceWorksheet.Cells(i, "A").Value = TargetWorksheet.Cells(j, "External Trade ID").Value Then
                        ' Copy data from source to target worksheet
                        SourceWorksheet.Rows(i).Copy TargetWorksheet.Rows(lastRowTarget + 1)
                        matchFound = True
                        Exit For ' Exit the target worksheet loop once a match is found
                    End If
                Next j
            Next i
            
            ' Close the source workbook
            SourceWorkbook.Close SaveChanges:=False
            
            ' Inform the user about the result
            If matchFound Then
                MsgBox "Data merged from " & FileName & " successfully."
            Else
                MsgBox "No matching data found to merge from " & FileName & "."
            End If
        End If
        
        ' Get the next file in the folder
        FileName = Dir
    Loop
End Sub