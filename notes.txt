Sub ProcessTradeData()
    Dim tradeDataSheet As Worksheet
    Dim ssiaSheet As Worksheet
    Dim lastRowTradeData As Long
    Dim lastRowSSIA As Long
    Dim i As Long

    ' Set reference to TradeData and SSIAffirmation sheets
    Set tradeDataSheet = ThisWorkbook.Sheets("TradeData")
    Set ssiaSheet = ThisWorkbook.Sheets("SSIAffirmation")

    ' Find the last row in TradeData sheet
    lastRowTradeData = tradeDataSheet.Cells(tradeDataSheet.Rows.Count, "B").End(xlUp).Row

    ' Find the last row in SSIAffirmation sheet
    lastRowSSIA = ssiaSheet.Cells(ssiaSheet.Rows.Count, "B").End(xlUp).Row

    ' Loop through TradeData sheet
    For i = lastRowTradeData To 2 Step -1 ' Start from the last row and move upwards
        ' Check if the value in column BI exists in SSIAffirmation sheet column B
        If Not IsInArray(tradeDataSheet.Cells(i, 57).Value, ssiaSheet.Range("B2:B" & lastRowSSIA).Value) Then
            ' If no match found, delete the row
            tradeDataSheet.Rows(i).Delete
        End If
    Next i

    ' After deleting rows, call the function to create emails for matching rows
    CreateEmailsForMatchingRows tradeDataSheet, ssiaSheet
End Sub

Sub CreateEmailsForMatchingRows(tradeDataSheet As Worksheet, ssiaSheet As Worksheet)
    Dim outlookApp As Object
    Dim outlookMail As Object
    Dim lastRowTradeData As Long
    Dim i As Long

    ' Set up Outlook
    Set outlookApp = CreateObject("Outlook.Application")

    ' Find the last row in TradeData sheet after deleting non-matching rows
    lastRowTradeData = tradeDataSheet.Cells(tradeDataSheet.Rows.Count, "B").End(xlUp).Row

    ' Loop through the remaining rows in TradeData sheet
    For i = 2 To lastRowTradeData
        ' Create email only for rows with matching values
        CreateEmail tradeDataSheet, i, ssiaSheet, outlookApp
    Next i

    ' Clean up Outlook
    Set outlookApp = Nothing
End Sub

