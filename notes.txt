Sub Three()
    Dim wsTrade As Worksheet
    Dim wsContacts As Worksheet
    Dim lastRow As Long
    Dim latestSrcCol As Integer
    Dim quantityCol As Integer
    Dim i As Long
    Dim outlookApp As Object
    Dim outlookMail As Object
    Dim emailBody As String
    Dim toAddress As Variant

    ' Set worksheets
    Set wsTrade = ThisWorkbook.Sheets("TradeData")
    Set wsContacts = ThisWorkbook.Sheets("Contacts")

    ' Set column numbers based on headers
    latestSrcCol = WorksheetFunction.Match("Latest Src", wsTrade.Rows(1), 0)
    quantityCol = WorksheetFunction.Match("Quantity", wsTrade.Rows(1), 0)

    ' Find the last row in the TradeData sheet
    lastRow = wsTrade.Cells(wsTrade.Rows.Count, latestSrcCol).End(xlUp).Row

    ' Create Outlook Application
    Set outlookApp = CreateObject("Outlook.Application")

    ' Loop through each row in "Latest Src" column
    For i = 2 To lastRow
        ' Check if the value is "WIService" and Quantity is greater than or equal to 100,000,000
        If wsTrade.Cells(i, latestSrcCol).Value = "WIService" And wsTrade.Cells(i, quantityCol).Value >= 100000000 Then
            ' Debugging: Display the value in column "BI" for the current row
            Debug.Print "BI Value for Row " & i & ": " & wsTrade.Cells(i, "BI").Value
            
            ' VLOOKUP to retrieve "To" address from the "Contacts" sheet
            toAddress = Application.VLookup(wsTrade.Cells(i, "BI").Value, wsContacts.Columns("B:C"), 2, False)
            
            ' Debugging: Display the retrieved "To" address
            Debug.Print "To Address for Row " & i & ": " & toAddress
            
            ' Check if the VLOOKUP was successful
            If Not IsError(toAddress) Then
                ' Generate HTML-formatted email body
                emailBody = "<html><body>"
                emailBody = emailBody & "<p><strong>Trade ID:</strong> " & wsTrade.Cells(i, WorksheetFunction.Match("Trade ID", wsTrade.Rows(1), 0)).Value & "</p>"
                emailBody = emailBody & "<p><strong>Quantity:</strong> " & wsTrade.Cells(i, quantityCol).Value & "</p>"
                ' ... (other fields)
                emailBody = emailBody & "<p><strong>Client Contact:</strong> " & wsTrade.Cells(i, WorksheetFunction.Match("Client Contact", wsTrade.Rows(1), 0)).Value & "</p>"
                
                ' ... (rest of the email body generation)
                emailBody = emailBody & "</body></html>"

                ' Create a new mail item
                Set outlookMail = outlookApp.CreateItem(0)

                ' Customize email properties
                With outlookMail
                    .Subject = "Trade Details for WIService"
                    .HTMLBody = emailBody
                    .Recipients.Add toAddress ' Use retrieved "To" address
                    .Display
                End With

                ' Release Outlook mail object
                Set outlookMail = Nothing
            Else
                MsgBox "Error retrieving 'To' address for Trade ID: " & wsTrade.Cells(i, WorksheetFunction.Match("Trade ID", wsTrade.Rows(1), 0)).Value, vbExclamation
            End If
        End If
    Next i

    ' Release Outlook application object
    Set outlookApp = Nothing
End Sub

