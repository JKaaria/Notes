Sub GenerateEmails()
    Dim ws As Worksheet
    Dim failCodeColumn As Range
    Dim failDescriptionColumn As Range
    Dim lastRow As Long
    Dim i As Long
    Dim outlookApp As Object
    Dim outlookMail As Object
    Dim failCodesTable As Range
    Dim vlookupResult As Variant

    ' Set the worksheet variable
    Set ws = ThisWorkbook.Sheets("AFT")

    ' Find the header row and locate the "Fail Code" and "Fail Description" columns
    On Error Resume Next
    Set failCodeColumn = ws.Rows(1).Find(What:="Fail Code", LookIn:=xlValues, LookAt:=xlWhole)
    Set failDescriptionColumn = ws.Rows(1).Find(What:="Fail Description", LookIn:=xlValues, LookAt:=xlWhole)
    On Error GoTo 0

    ' Check if the "Fail Code" and "Fail Description" columns are found
    If Not (failCodeColumn Is Nothing Or failDescriptionColumn Is Nothing) Then
        ' Find the last row in the "Fail Code" column
        lastRow = ws.Cells(ws.Rows.Count, failCodeColumn.Column).End(xlUp).Row

        ' Define the range for the FailCodes table
        Set failCodesTable = ThisWorkbook.Sheets("YourSheetName").Range("FailCodes") ' Adjust "YourSheetName" and "FailCodes" accordingly

        ' Loop through each row in the "Fail Code" column
        For i = 2 To lastRow ' Assuming data starts from row 2

            ' Perform VLOOKUP to check if an email should be generated
            vlookupResult = Application.VLookup(ws.Cells(i, failCodeColumn.Column).Value, failCodesTable.Columns(1), 3, False)

            ' Check if the result is blank
            If IsEmpty(vlookupResult) Then
                ' Get the values from specified columns
                ' (Same as previous code)

                ' Create email body
                Dim emailBody As String
                emailBody = "Trade Date: " & tradeDate & vbCrLf _
                          & "P/S: " & ps & vbCrLf _
                          & "Price: " & price & vbCrLf _
                          & "Value Date: " & valueDate & vbCrLf _
                          & "Nominal: " & nominal & vbCrLf _
                          & "Ticket: " & ticket & vbCrLf _
                          & "Instrument ID: " & instrumentID & vbCrLf _
                          & "Instrument: " & instrument & vbCrLf _
                          & "Accrued Interest: " & accruedInterest & vbCrLf _
                          & "Net Proceeds: " & netProceeds & vbCrLf _
                          & "Fail Description: " & failDescription & vbCrLf _
                          & "Salesperson Name: " & salespersonName & vbCrLf _
                          & "Crest ID: " & crestID

                ' Create and display email
                Set outlookApp = CreateObject("Outlook.Application")
                Set outlookMail = outlookApp.CreateItem(0)
                With outlookMail
                    .Subject = failDescription
                    .Body = emailBody
                    .Display
                End With

                ' Release Outlook objects
                Set outlookMail = Nothing
                Set outlookApp = Nothing
            End If
        Next i
    Else
        MsgBox "Column 'Fail Code' or 'Fail Description' not found in the worksheet."
    End If
End Sub

