Sub ReconcileEntities()
    On Error Resume Next ' Enable error handling
    
    Dim tradeDataSheet As Worksheet
    Dim logicTableSheet As Worksheet
    Dim tradeDataRange As Range
    Dim logicTableRange As Range
    Dim counterpartyIDs As Variant
    Dim tradeDataRow As Range
    Dim entityMatch As Range
    
    ' Set references to sheets
    Set tradeDataSheet = ThisWorkbook.Sheets("TradeData")
    Set logicTableSheet = ThisWorkbook.Sheets("LogicTable")
    
    ' Set the range for TradeData and LogicTable
    Set tradeDataRange = tradeDataSheet.UsedRange
    Set logicTableRange = logicTableSheet.UsedRange
    
    ' Define Counterparty IDs
    counterpartyIDs = Array("41154150", "43002923", "10101678", "10400868", "10105032", "40201510", _
                            "10351848", "40114353", "10300694", "10156783", "10107349", "10300737", _
                            "40013551", "10401036", "40644161", "40009160", "10400910", "42169389", _
                            "10301042", "10300558", "10400695", "40067364", "40067356", "42734506", _
                            "10401031", "40050448")
    
    ' Loop through each row in TradeData
    For Each tradeDataRow In tradeDataRange.Rows
        ' Check if ISIN is not empty and Counterparty ID is in the array
        If Not IsEmpty(tradeDataRow.Cells(1, "ISIN").Value) And _
           IsInArray(tradeDataRow.Cells(1, "Counterparty ID").Value, counterpartyIDs) Then
           
            ' Check if Settle Legal Entity is not empty
            If Not IsEmpty(tradeDataRow.Cells(1, "Settle Legal Entity").Value) Then
                ' Find the corresponding row in LogicTable based on Entity
                Set entityMatch = logicTableRange.Columns("Entity").Find(tradeDataRow.Cells(1, "Settle Legal Entity").Value)
                
                ' If a match is found, you can perform further actions as needed
                If Not entityMatch Is Nothing Then
                    ' Your reconciliation logic here
                    ' For example, you might want to update a status or perform some calculations
                End If
            End If
        End If
    Next tradeDataRow
    
    On Error GoTo 0 ' Disable error handling
End Sub

Function IsInArray(value As Variant, arr As Variant) As Boolean
    ' Check if a value is in the array
    Dim element As Variant
    For Each element In arr
        If value = element Then
            IsInArray = True
            Exit Function
        End If
    Next element
    IsInArray = False
End Function
