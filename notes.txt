Sub MergeDataFromFiles()
    Dim CurrentFolderPath As String
    Dim DelphiFile As String
    Dim TmpFile As String
    Dim wb As Workbook
    Dim wsFails As Worksheet
    Dim lastRowDelphi As Long
    Dim lastRowTmp As Long
    Dim i As Long, j As Long
    Dim matchFound As Boolean
    
    ' Get the current working directory path
    CurrentFolderPath = ThisWorkbook.Path
    
    ' Check for the Delphi file in the current folder
    DelphiFile = Dir(CurrentFolderPath & "\delphi_fails*.xls*")
    
    ' Check for the Tmp file in the current folder
    TmpFile = Dir(CurrentFolderPath & "\sstemp*.xls*")
    
    ' Check if both files were found
    If DelphiFile = "" Or TmpFile = "" Then
        MsgBox "One or both source files not found in the current directory."
        Exit Sub
    End If
    
    ' Open the Delphi file
    Set wb = Workbooks.Open(CurrentFolderPath & "\" & DelphiFile)
    
    ' Set reference to the "Fails" worksheet in the Delphi file
    On Error Resume Next
    Set wsFails = wb.Worksheets("Fails")
    On Error GoTo 0
    
    ' Check if the "Fails" worksheet exists, create it if not
    If wsFails Is Nothing Then
        Set wsFails = wb.Worksheets.Add
        wsFails.Name = "Fails"
    End If
    
    ' Find the last row in each source sheet
    lastRowDelphi = wsFails.Cells(wsFails.Rows.Count, "A").End(xlUp).Row
    
    ' Close the Delphi file
    wb.Close SaveChanges:=False
    
    ' Open the Tmp file
    Set wb = Workbooks.Open(CurrentFolderPath & "\" & TmpFile)
    
    ' Find the last row in the Tmp sheet
    lastRowTmp = wb.Sheets(1).Cells(wb.Sheets(1).Rows.Count, "A").End(xlUp).Row
    
    ' Initialize a flag to check for matches
    matchFound = False
    
    ' Loop through the Delphi sheet
    For i = 2 To lastRowDelphi ' Assuming headers are in row 1
        matchFound = False
        ' Loop through the Tmp sheet
        For j = 2 To lastRowTmp ' Assuming headers are in row 1
            ' Check if there is a match based on "External Trade ID"
            If wsFails.Cells(i, "A").Value = wb.Sheets(1).Cells(j, "Ticket").Value Then
                ' Copy data from Tmp to Fails
                wb.Sheets(1).Rows(j).Copy wsFails.Rows(i)
                matchFound = True
                Exit For ' Exit the Tmp loop once a match is found
            End If
        Next j
    Next i
    
    ' Close the Tmp file
    wb.Close SaveChanges:=False
    
    ' Inform the user about the result
    If matchFound Then
        MsgBox "Data merged successfully."
    Else
        MsgBox "No matching data found to merge."
    End If
End Sub